# DAG Documentation: `smokingshop_mariadb_to_clickhouse_improved_1`

## Общее описание

Этот DAG выполняет **инкрементальную синхронизацию данных** из MariaDB в ClickHouse для системы учета продаж SmokingShop. DAG обеспечивает надежную передачу данных с обработкой обновлений, новых записей и контролем качества.

## Расписание выполнения

- **Запуск**: 5:15, 7:15, 9:15, 11:15, 13:15 (MSK) ежедневно
- **Тип**: Инкрементальная синхронизация
- **Максимальное количество параллельных запусков**: 1

## Архитектура данных

### Источник (MariaDB)
- **Таблица**: `smokingshop_report_1`
- **Дополнительная таблица**: `sbis_accounts` (джойн по `sbis_account_id`)
- **Ключевые поля**: `sbis_account_id`, `document_id`, `tabular_row_id`

### Приемник (ClickHouse)
- **Таблица**: `smokingshop_sales_1`
- **Движок**: MergeTree
- **Партиционирование**: по месяцам (`toYYYYMM(sbis_date)`)
- **Сортировка**: по дате, номеру и ID строки

## Задачи DAG

### 1. `check_data_volume` ✅
**Назначение**: Проверка объема данных перед обработкой
- Определяет общее количество записей в исходной таблице
- Классифицирует датасет по размеру (NORMAL/WARNING/CRITICAL)
- Адаптирует параметры обработки в зависимости от объема данных

### 2. `extract_from_mariadb` ✅  
**Назначение**: Извлечение данных из MariaDB
- Чтение данных чанками для экономии памяти
- Создание составных ключей для дедупликации
- Сохранение данных во временные файлы (Parquet/CSV)
- Генерация файла ключей для последующего сравнения

### 3. `find_changed_cost_records` 🔍
**Назначение**: Обнаружение изменений в ценах себестоимости
- Сравнение сумм `nomenclature_cost_price` + `nomenclature_cost_price_total`
- Выявление записей с измененными финансовыми данными
- Сохранение ключей измененных записей для обработки

### 4. `delete_changed_records_from_clickhouse` 🗑️
**Назначение**: Удаление устаревших записей из ClickHouse
- Пакетное удаление записей с измененными ценами
- Использование батчинга для оптимизации производительности
- Подготовка места для обновленных данных

### 5. `compare_data` ⚖️
**Назначение**: Сравнение ключей для выявления новых записей
- Сравнение множеств ключей MariaDB и ClickHouse
- Выявление новых записей для вставки
- Оптимизированное сравнение в памяти

### 6. `load_incremental_to_clickhouse` 📤
**Назначение**: Загрузка новых данных в ClickHouse
- Преобразование типов данных для совместимости
- Пакетная вставка новых записей
- Автоматическое создание таблицы при необходимости

### 7. `cleanup_file` 🧹
**Назначение**: Очистка временных файлов
- Удаление временных файлов данных и ключей
- Освобождение дискового пространства
- Запускается даже при частичном успехе выполнения DAG

## Особенности реализации

### Обработка ошибок
- **Повторные попытки**: Экспоненциальная backoff-стратегия (макс. 3 попытки)
- **Таймауты соединений**: 300 секунд для устойчивости к сетевым проблемам
- **Обработка исключений**: Специфичная для каждой СУБД (MySQL, ClickHouse)

### Оптимизация производительности
- **Чанкование**: Обработка данных порциями по 50k-100k записей
- **Управление памятью**: Явное освобождение ресурсов и сборка мусора
- **Пул соединений**: Настроенный SQLAlchemy engine для MariaDB

### Мониторинг и логирование
- **Детальное логирование**: Прогресс обработки, объемы данных, ошибки
- **XCom обмен**: Передача метаданных между задачами
- **Примеры данных**: Логирование sample-данных для отладки

## Поток данных

```
MariaDB → Extract → Detect Changes → Delete Old → Compare → Load New → ClickHouse
    ↓          ↓           ↓            ↓          ↓         ↓         ↓
  Check    Save Temp    Find Changed  Delete    Compare   Insert    Final State
  Volume    Files       Records       Old       Keys      New
```

## Требования к системе

- **Apache Airflow**: с поддержкой PythonOperator
- **Провайдеры**: MySQL, ClickHouse plugin
- **Библиотеки**: pandas, pyarrow, sqlalchemy
- **Дисковое пространство**: ~2x размера данных для временных файлов

## Безопасность

- Использование Airflow Connections для хранения учетных данных
- Очистка временных файлов после выполнения
- Ограничение параллельных запусков для избежания конфликтов
